---
name: Slash Command Handler

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  pull-requests: write # Required to add labels and reactions
  actions: write       # Required to rerun workflows
  issues: write        # Required for comment reactions in some contexts

jobs:
  slash_lint_wanted:
    # Only run if it is a PR comment with a recognized command
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/tag-run-lint')
    runs-on: ubuntu-latest
    steps:
    - name: Trigger lint by label manipulation
      uses: actions/github-script@v7
      with:
        script: |
          // Delay to ensure label removal is processed before re-adding
          // This prevents race conditions in workflow triggering
          const LABEL_REMOVAL_DELAY_MS = 1000;
          
          // Remove the label if it exists, then add it
          // This ensures the 'labeled' event is triggered
          try {
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'lint wanted'
            });
            // Wait to ensure GitHub's label removal event is fully processed
            // before adding the label back, preventing race conditions
            await new Promise(resolve => setTimeout(resolve, LABEL_REMOVAL_DELAY_MS));
          } catch (error) {
            // Label might not exist, that's okay
            console.log('Label removal failed (label may not exist):', error.message);
          }
          
          // Add the label, which should trigger the lint workflow
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: ['lint wanted']
          });
